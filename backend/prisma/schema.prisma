generator client {
  provider = "prisma-client-js"
  output = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              Int         @id @default(autoincrement())
  name            String
  email           String      @unique
  password        String
  createdAt       DateTime    @default(now())
  role            UserRole    @default(USER)
  totpSecret      String?
  totpEnabled     Boolean     @default(false)
  orders          Order[]
  reward          UserReward?
  favorites       UserFavorite[]
}

model UserReward {
  id              Int         @id @default(autoincrement())
  userId          Int         @unique
  productId       Int
  discountPercent Int         // 10-99
  generatedAt     DateTime    @default(now())
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  product         Product     @relation("UserReward", fields: [productId], references: [id])
}

model Product {
  id              Int         @id @default(autoincrement())
  name            String
  slug            String      @unique // Np. "iphone-15-pro-max"
  price           Int
  description     String      @default("")
  discount        Int         @default(0) // Rabat procentowy, np. 10 dla 10%
  imageUrl        String    
  stock           Int         @default(0)
  isAvailable     Boolean     @default(true)
  orderItems      OrderItem[]
  promotion       Promotion[]
  hotShot         HotShot?    @relation("hotShotProduct")
  userRewards     UserReward[] @relation("UserReward")
  userFavorites   UserFavorite[]
  categoryId      Int
  category        Category    @relation(fields: [categoryId], references: [id])
}

model Category {
  id              Int         @id @default(autoincrement())
  name            String      @unique
  slug            String      @unique
  products        Product[]
}

model Order {
  id              Int         @id @default(autoincrement())
  userId          Int
  totalAmount     Int
  stripeSession   String?     @unique
  status          OrderStatus @default(PENDING)
  createdAt       DateTime    @default(now())
  user            User        @relation(fields: [userId], references: [id])
  items           OrderItem[]
}

model OrderItem {
  id              Int         @id @default(autoincrement())
  orderId         Int
  productId       Int
  quantity        Int
  price           Int
  order           Order       @relation(fields: [orderId], references: [id])
  product         Product     @relation(fields: [productId], references: [id])
}

model Promotion {
  id              Int         @id @default(autoincrement())
  productId       Int
  createdAt       DateTime    @default(now())
  product         Product     @relation(fields: [productId], references: [id])
}

model HotShot {
  id                    Int       @id @default(autoincrement())
  productId             Int       @unique
  product               Product   @relation("hotShotProduct", fields: [productId], references: [id])
  discountPercent       Int       // Np. 60 dla 60% zniżki
  stockLimit            Int       // Ile sztuk dostępne po promocyjnej cenie
  stockSold             Int       @default(0) // Ile już sprzedano
  originalPrice         Int       // Oryginalna cena przed promocją
  startedAt             DateTime  @default(now())
  expiresAt             DateTime  // Kiedy promocja się skończy (teraz + 12h)
  isActive              Boolean   @default(true)
}

model UserFavorite {
  id              Int       @id @default(autoincrement())
  userId          Int
  productId       Int
  createdAt       DateTime  @default(now())
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  @@unique([userId, productId])
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  COMPLETED
  CANCELED
}

enum UserRole {
  USER
  ADMIN
}
